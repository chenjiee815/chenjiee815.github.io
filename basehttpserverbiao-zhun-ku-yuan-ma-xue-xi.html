<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Chen Jie" />
        <meta name="copyright" content="Chen Jie" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="python, stdlibs, Python, " />

<meta property="og:title" content="BaseHTTPServer标准库源码学习 "/>
<meta property="og:url" content="http://chenjiee815.github.io/basehttpserverbiao-zhun-ku-yuan-ma-xue-xi.html" />
<meta property="og:description" content="Contents 简介 HTTP 各版本协议简介 HTTP/0.9 HTTP/1.0 HTTP/1.1 默认值 DEFAULT_ERROR_MESSAGE DEFAULT_ERROR_CONTENT_TYPE _quote_html HTTPServer allow_reuse_address BaseHTTPRequestHandler URL 长度限制 打印日志的相关方法 responses 简介 该模块不实现任何具体的 HTTP 请求（比如 GET、POST、HEAD... ...）， 如果想了解深入了解，可以参见 SimpleHTTPServer 模块。 该模块只是实现了一个基本框架，让用户只需要关心如何处理具体的 HTTP 请求，并且部分实现了 HTTP/1.1 的长连接功能。 HTTP 各版本协议简介 HTTP 的消息格式定义基本如下： 起始行 ..." />
<meta property="og:site_name" content="January Star" />
<meta property="og:article:author" content="Chen Jie" />
<meta property="og:article:published_time" content="2014-11-20T09:48:13.476432" />
<meta name="twitter:title" content="BaseHTTPServer标准库源码学习 ">
<meta name="twitter:description" content="Contents 简介 HTTP 各版本协议简介 HTTP/0.9 HTTP/1.0 HTTP/1.1 默认值 DEFAULT_ERROR_MESSAGE DEFAULT_ERROR_CONTENT_TYPE _quote_html HTTPServer allow_reuse_address BaseHTTPRequestHandler URL 长度限制 打印日志的相关方法 responses 简介 该模块不实现任何具体的 HTTP 请求（比如 GET、POST、HEAD... ...）， 如果想了解深入了解，可以参见 SimpleHTTPServer 模块。 该模块只是实现了一个基本框架，让用户只需要关心如何处理具体的 HTTP 请求，并且部分实现了 HTTP/1.1 的长连接功能。 HTTP 各版本协议简介 HTTP 的消息格式定义基本如下： 起始行 ...">

        <title>BaseHTTPServer标准库源码学习  · January Star
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52167018-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://chenjiee815.github.io/"><span class=site-name>January Star</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://chenjiee815.github.io">Home</a></li>
                            <li ><a href="http://chenjiee815.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://chenjiee815.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://chenjiee815.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://chenjiee815.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://chenjiee815.github.io/basehttpserverbiao-zhun-ku-yuan-ma-xue-xi.html"> BaseHTTPServer标准库源码学习  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id4"> 简介 </a></li>
<li><a class="reference internal" href="#http" id="id5">HTTP 各版本协议简介 </a><ul>
<li><a class="reference internal" href="#http-0-9" id="id6">HTTP/0.9</a></li>
<li><a class="reference internal" href="#http-1-0" id="id7">HTTP/1.0</a></li>
<li><a class="reference internal" href="#http-1-1" id="id8">HTTP/1.1</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id2" id="id9"> 默认值 </a><ul>
<li><a class="reference internal" href="#default-error-message" id="id10">DEFAULT_ERROR_MESSAGE</a></li>
<li><a class="reference internal" href="#default-error-content-type" id="id11">DEFAULT_ERROR_CONTENT_TYPE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#quote-html" id="id12">_quote_html</a></li>
<li><a class="reference internal" href="#httpserver" id="id13">HTTPServer</a><ul>
<li><a class="reference internal" href="#allow-reuse-address" id="id14">allow_reuse_address</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basehttprequesthandler" id="id15">BaseHTTPRequestHandler</a><ul>
<li><a class="reference internal" href="#url" id="id16">URL 长度限制 </a></li>
<li><a class="reference internal" href="#id3" id="id17"> 打印日志的相关方法 </a></li>
<li><a class="reference internal" href="#responses" id="id18">responses</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id4"> 简介 </a></h2>
<p> 该模块不实现任何具体的 HTTP 请求（比如 GET、POST、HEAD... ...），</p>
<p> 如果想了解深入了解，可以参见 <cite>SimpleHTTPServer</cite> 模块。</p>
<p> 该模块只是实现了一个基本框架，让用户只需要关心如何处理具体的 HTTP 请求，并且部分实现了 HTTP/1.1 的长连接功能。</p>
</div>
<div class="section" id="http">
<h2><a class="toc-backref" href="#id5">HTTP 各版本协议简介 </a></h2>
<p>HTTP 的消息格式定义基本如下：</p>
<ol class="arabic simple">
<li> 起始行，必选，定义请求方法、请求路径等等 </li>
<li> 首部，可选，定义该消息的元数据 </li>
<li> 主体，可选，消息附带的数据 </li>
</ol>
<p> 消息头部与消息体使用 <cite>\r\n</cite> 来进行分割。</p>
<div class="section" id="http-0-9">
<h3><a class="toc-backref" href="#id6">HTTP/0.9</a></h3>
<p>HTTP 的 1991 原型版本称为 <cite>HTTP/0.9</cite> ，它的初衷是为了获取简单的 HTML。</p>
<p> 该协议有很多严重的设计缺陷，只适用于与老客户端进行交互，并且它只支持 GET 方法。</p>
<p> 它的请求消息就一行：</p>
<pre class="literal-block">
&lt;command&gt; &lt;path&gt;
</pre>
<p> 同时它的响应消息不包含消息头部，只包含响应数据。</p>
</div>
<div class="section" id="http-1-0">
<h3><a class="toc-backref" href="#id7">HTTP/1.0</a></h3>
<p> 该版本是第一个得到广泛应用的版本。</p>
<p> 它添加了版本号、各种 HTTP 首部、一些额外的 HTTP 方法，以及对多媒体对象的处理。</p>
<p> 请求消息格式：</p>
<pre class="literal-block">
&lt;command&gt; &lt;path&gt; &lt;version&gt;

HTTP 请求首部

HTTP 请求主体
</pre>
<p> 响应消息格式：</p>
<pre class="literal-block">
&lt;version&gt; &lt;responsecode&gt; &lt;responsestring&gt;

HTTP 响应首部

HTTP 响应主体
</pre>
</div>
<div class="section" id="http-1-1">
<h3><a class="toc-backref" href="#id8">HTTP/1.1</a></h3>
<p> 该版本重点关注的是校正 HTTP 设计中的结构性缺陷。明确语义，引入重要的性能优化措施，并删除一些不好的特性。</p>
<p> 比如本模块里部分支持 HTTP/1.1 定义的长连接功能。</p>
</div>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id9"> 默认值 </a></h2>
<p> 这两个没啥好解释的。</p>
<div class="section" id="default-error-message">
<h3><a class="toc-backref" href="#id10">DEFAULT_ERROR_MESSAGE</a></h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">DEFAULT_ERROR_MESSAGE</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">&lt;head&gt;</span>
<span class="s">&lt;title&gt;Error response&lt;/title&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">&lt;h1&gt;Error response&lt;/h1&gt;</span>
<span class="s">&lt;p&gt;Error code </span><span class="si">%(code)d</span><span class="s">.</span>
<span class="s">&lt;p&gt;Message: </span><span class="si">%(message)s</span><span class="s">.</span>
<span class="s">&lt;p&gt;Error code explanation: </span><span class="si">%(code)s</span><span class="s"> = </span><span class="si">%(explain)s</span><span class="s">.</span>
<span class="s">&lt;/body&gt;</span>
<span class="s">&quot;&quot;&quot;</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="default-error-content-type">
<h3><a class="toc-backref" href="#id11">DEFAULT_ERROR_CONTENT_TYPE</a></h3>
<p>DEFAULT_ERROR_CONTENT_TYPE = &quot;text/html&quot;</p>
</div>
</div>
<div class="section" id="quote-html">
<h2><a class="toc-backref" href="#id12">_quote_html</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_quote_html</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;amp;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;gt;&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table><p> 对 URL 进行简单的转码，用来防止 <cite>XSS</cite> 。</p>
<p> 详情参见： <a class="reference external" href="http://bugs.python.org/issue1100201">Issue1100201</a></p>
<blockquote>
<p> 该 Bug 简单来说就是利用上面的 <cite>DEFAULT_ERROR_MESSAGE</cite> 会将 URL 也包含在内的特点，</p>
<p> 构造一个包含可执行代码 ( 比如 JS 代码 ) 的 URL，这样就会导致 <cite>HTTPServer</cite> 返回的错误页面中的代码会被浏览器执行。</p>
</blockquote>
<p>PS: <cite>cgi.escape</cite> 已经提供了类似的方法 , 估计当时写该模块时 <cite>cgi</cite> 模块还未加入 , 或者作者想减少模块之间的依赖 , 没必要只要使用一个简单的函数而导入一个新的模块 .</p>
</div>
<div class="section" id="httpserver">
<h2><a class="toc-backref" href="#id13">HTTPServer</a></h2>
<p><cite>HTTPServer</cite> 的代码量很少，原因很简单，HTTP 协议基本可分为两个方面：</p>
<ol class="arabic simple">
<li> 规定了 TCP 通信的格式与内容 </li>
<li> 规定了如何使用 TCP 连接 </li>
</ol>
<p> 它本质上就是一个 <cite>TCPServer</cite> ，主要看它是如何进行请求处理的。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>

    <span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">server_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 重载 `server_bind` 是为了获取 `server_name` 和 `server_port`</span>
        <span class="n">SocketServer</span><span class="o">.</span><span class="n">TCPServer</span><span class="o">.</span><span class="n">server_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span>
</pre></div>
</td></tr></table><div class="section" id="allow-reuse-address">
<h3><a class="toc-backref" href="#id14">allow_reuse_address</a></h3>
<p> 一般来说，一个端口释放后会等待两分钟之后才能再被使用，<cite>allow_reuse_address</cite> 是让端口释放后立即就可以被再次使用。</p>
<p> 如果想了解有关详情，请 <a class="reference external" href="https://www.google.com.hk/#safe=strict&amp;q=SO_REUSEADDR&amp;btnK=Google+%E6%90%9C%E7%B4%A2">Google SO_REUSEADDR</a></p>
</div>
</div>
<div class="section" id="basehttprequesthandler">
<h2><a class="toc-backref" href="#id15">BaseHTTPRequestHandler</a></h2>
<p> 该类就是进行具体 HTTP 请求（GET、POST... ...）的类。</p>
<p> 如果用户想处理 HTTP 请求（假定 HTTP 方法为 SPAM），只需要定义 <cite>do_SPAM</cite> 方法即可。</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last"> 此处的 <cite>SPAM</cite> 是大小写敏感的。</p>
</div>
<p> 只需要按如下格式编写代码即可：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyHTTPRequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">HELLO_WORLD</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">&lt;p&gt;Hello, web!&lt;/p&gt;</span>
<span class="s">&lt;/body&gt;</span>
<span class="s">&lt;/html&gt;</span>
<span class="s">&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HELLO_WORLD</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HELLO_WORLD</span><span class="p">)</span>
</pre></div>
</td></tr></table><p> 此外， <cite>BaseHTTPRequestHandler</cite> 中还有一系列的属性，可以获取以及处理与请求相关的信息。</p>
<ul class="simple">
<li>client_address: 客户端 IP</li>
<li>command: HTTP 方法 </li>
<li>path: HTTP 请求路径 </li>
<li>version: HTTP 版本号 </li>
<li>headers: HTTP 请求首部，它是 <cite>mimetools.Message</cite> 实例 </li>
<li>rfile: 读入请求消息的文件对象 </li>
<li>wfile: 写入响应消息的文件对象 </li>
</ul>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last"> 如果要返回响应消息，第一行必须要写入响应首行；然后再写入 0 到多个的响应头部；然后再写入一个空行；最后根据需要再写入消息主体。</p>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BaseHTTPRequestHandler</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="p">):</span>

    <span class="n">sys_version</span> <span class="o">=</span> <span class="s">&quot;Python/&quot;</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">server_version</span> <span class="o">=</span> <span class="s">&quot;BaseHTTP/&quot;</span> <span class="o">+</span> <span class="n">__version__</span>

    <span class="n">default_request_version</span> <span class="o">=</span> <span class="s">&quot;HTTP/0.9&quot;</span>

    <span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 解释一个 HTTP 请求的首行及头部，并将解析结果放到自身的各个属性中 </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># set in case of error on the first line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">=</span> <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_request_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">requestline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span>
        <span class="n">requestline</span> <span class="o">=</span> <span class="n">requestline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="o">=</span> <span class="n">requestline</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">requestline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c"># 非 HTTP/0.9 版本 </span>
            <span class="n">command</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">words</span>
            <span class="k">if</span> <span class="n">version</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;HTTP/&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;Bad request version (</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># 解释请求消息中的 HTTP 版本号，这里最好也封装起来 </span>
                <span class="n">base_version_number</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">version_number</span> <span class="o">=</span> <span class="n">base_version_number</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
                <span class="c"># RFC 2145 section 3.1 says there can be only one &quot;.&quot; and</span>
                <span class="c">#   - major and minor numbers MUST be treated as</span>
                <span class="c">#      separate integers;</span>
                <span class="c">#   - HTTP/2.4 is a lower version than HTTP/2.13, which in</span>
                <span class="c">#      turn is lower than HTTP/12.3;</span>
                <span class="c">#   - Leading zeros MUST be ignored by recipients.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">version_number</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">version_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_number</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_number</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;Bad request version (</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">version_number</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">&gt;=</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">version_number</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">505</span><span class="p">,</span>
                          <span class="s">&quot;Invalid HTTP Version (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">base_version_number</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c"># 请求首行只有两个字段，说明是 HTTP/0.9</span>
            <span class="n">command</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">words</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">command</span> <span class="o">!=</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span> <span class="c"># HTTP/0.9 只支持 GET 方法 </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span>
                                <span class="s">&quot;Bad HTTP/0.9 request type (</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">words</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;Bad request syntax (</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">requestline</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">=</span> <span class="n">command</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">version</span>

        <span class="c"># Examine the headers and look for a Connection directive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MessageClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># 这里就是所谓的部分支持 HTTP/1.1 版本的长连接功能 </span>
        <span class="n">conntype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Connection&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conntype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;close&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">conntype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;keep-alive&#39;</span> <span class="ow">and</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">&gt;=</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">handle_one_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 处理一次请求 &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># 读取请求数据的第一行，不过这里限制了第一行的大小 </span>
            <span class="c"># 由于方法名和版本号长度基本算固定的，所以这里就相当于限制 URL 的长度 </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">65537</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">:</span> <span class="c"># HTTP 请求首行太长了，对应的 HTTP code 码就是 414</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">414</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c"># 没有读到任何数据，说明通信异常，该 socket 连接可以直接关闭 </span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span>
            <span class="c"># 解析请求消息出错 </span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_request</span><span class="p">():</span>
                <span class="c"># An error code has been sent, just exit</span>
                <span class="k">return</span>
            <span class="c"># 以下的几行代码可以封装起来 </span>
            <span class="c"># 根据 HTTP 方法来调用 `do_SPAM` 方法。</span>
            <span class="n">mname</span> <span class="o">=</span> <span class="s">&#39;do_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mname</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">501</span><span class="p">,</span> <span class="s">&quot;Unsupported method (</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mname</span><span class="p">)</span>
            <span class="n">method</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Request timed out: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 入口方法，从这里开始整个 HTTP 请求处理及响应 &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># 关闭连接标志 </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_one_request</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_one_request</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 发送一个错误格式的响应消息 &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># 网上有人吐槽 `long` 为 Python 的内置类型，不建议当作变量名 </span>
            <span class="n">short</span><span class="p">,</span> <span class="nb">long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">short</span><span class="p">,</span> <span class="nb">long</span> <span class="o">=</span> <span class="s">&#39;???&#39;</span><span class="p">,</span> <span class="s">&#39;???&#39;</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">short</span>
        <span class="n">explain</span> <span class="o">=</span> <span class="nb">long</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="s">&quot;code </span><span class="si">%d</span><span class="s">, message </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="c"># 这里使用了 `_quote_html` ，至于为什么使用，上面已有说明。</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_message_format</span> <span class="o">%</span>
                   <span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">_quote_html</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="s">&#39;explain&#39;</span><span class="p">:</span> <span class="n">explain</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_content_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Connection&#39;</span><span class="p">,</span> <span class="s">&#39;close&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="c"># 这里的 HTTP code 码都硬编码了，不建议。</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">!=</span> <span class="s">&#39;HEAD&#39;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">304</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="n">error_message_format</span> <span class="o">=</span> <span class="n">DEFAULT_ERROR_MESSAGE</span>
    <span class="n">error_content_type</span> <span class="o">=</span> <span class="n">DEFAULT_ERROR_CONTENT_TYPE</span>

    <span class="k">def</span> <span class="nf">send_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 发送响应消息 &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_request</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="c"># HTTP/0.9 版本没有响应消息头部定义 </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">!=</span> <span class="s">&#39;HTTP/0.9&#39;</span><span class="p">:</span>
            <span class="c"># 响应消息首行 </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
            <span class="c"># print (self.protocol_version, code, message)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_string</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&#39;Date&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_time_string</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">send_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># 写入响应头部，HTTP/0.9 版本没有响应消息头部定义 </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">!=</span> <span class="s">&#39;HTTP/0.9&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="c"># HTTP/1.1 协议规定 </span>
        <span class="c"># 如果不需要支持长连接，则返回 `close`</span>
        <span class="c"># 反之，返回 `keep-alive`</span>
        <span class="k">if</span> <span class="n">keyword</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;connection&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;close&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;keep-alive&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">end_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># HTTP 消息头部和消息体之间有一个空行，以 \r\n 分割 </span>
        <span class="c"># HTTP/0.9 版本只要求返回消息体，没有响应消息头部定义 </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span> <span class="o">!=</span> <span class="s">&#39;HTTP/0.9&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
        <span class="c"># 打印请求信息 </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">requestline</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># 打印错误信息，不过这里还是简单调用了 log_message 方法，进行标准输出了 </span>
        <span class="c"># 规范的做法应该进行错误输出 </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="c"># 可重载，详见下面的说明 </span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> - - [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">log_date_time_string</span><span class="p">(),</span>
                          <span class="n">format</span><span class="o">%</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">version_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_version</span>

    <span class="k">def</span> <span class="nf">date_time_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># 当前的日期与时间字符串，用于响应消息头部中的 Date 字段 </span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">wd</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">, </span><span class="si">%02d</span><span class="s"> </span><span class="si">%3s</span><span class="s"> </span><span class="si">%4d</span><span class="s"> </span><span class="si">%02d</span><span class="s">:</span><span class="si">%02d</span><span class="s">:</span><span class="si">%02d</span><span class="s"> GMT&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weekdayname</span><span class="p">[</span><span class="n">wd</span><span class="p">],</span>
                <span class="n">day</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthname</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">year</span><span class="p">,</span>
                <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">log_date_time_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 当前的时间，用于日志记录 </span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%02d</span><span class="s">/</span><span class="si">%3s</span><span class="s">/</span><span class="si">%04d</span><span class="s"> </span><span class="si">%02d</span><span class="s">:</span><span class="si">%02d</span><span class="s">:</span><span class="si">%02d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">day</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthname</span><span class="p">[</span><span class="n">month</span><span class="p">],</span> <span class="n">year</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">ss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">weekdayname</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Mon&#39;</span><span class="p">,</span> <span class="s">&#39;Tue&#39;</span><span class="p">,</span> <span class="s">&#39;Wed&#39;</span><span class="p">,</span> <span class="s">&#39;Thu&#39;</span><span class="p">,</span> <span class="s">&#39;Fri&#39;</span><span class="p">,</span> <span class="s">&#39;Sat&#39;</span><span class="p">,</span> <span class="s">&#39;Sun&#39;</span><span class="p">]</span>

    <span class="n">monthname</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span>
                 <span class="s">&#39;Jan&#39;</span><span class="p">,</span> <span class="s">&#39;Feb&#39;</span><span class="p">,</span> <span class="s">&#39;Mar&#39;</span><span class="p">,</span> <span class="s">&#39;Apr&#39;</span><span class="p">,</span> <span class="s">&#39;May&#39;</span><span class="p">,</span> <span class="s">&#39;Jun&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Jul&#39;</span><span class="p">,</span> <span class="s">&#39;Aug&#39;</span><span class="p">,</span> <span class="s">&#39;Sep&#39;</span><span class="p">,</span> <span class="s">&#39;Oct&#39;</span><span class="p">,</span> <span class="s">&#39;Nov&#39;</span><span class="p">,</span> <span class="s">&#39;Dec&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">address_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 获取客户端地址，用来进行日志记录。</span>
        <span class="c"># 此处可能会有 DNS 解析问题。</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

    <span class="c"># Essentially static class variables</span>

    <span class="c"># The version of the HTTP protocol we support.</span>
    <span class="c"># Set this to HTTP/1.1 to enable automatic keepalive</span>
    <span class="n">protocol_version</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.0&quot;</span>

    <span class="c"># The Message-like class used to parse headers</span>
    <span class="n">MessageClass</span> <span class="o">=</span> <span class="n">mimetools</span><span class="o">.</span><span class="n">Message</span>

    <span class="n">responses</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Continue&#39;</span><span class="p">,</span> <span class="s">&#39;Request received, please continue&#39;</span><span class="p">),</span>
        <span class="o">...</span> <span class="o">...</span>
        <span class="mi">200</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;Request fulfilled, document follows&#39;</span><span class="p">),</span>
        <span class="o">...</span> <span class="o">...</span>
        <span class="mi">300</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Multiple Choices&#39;</span><span class="p">,</span>
              <span class="s">&#39;Object has several resources -- see URI list&#39;</span><span class="p">),</span>
        <span class="o">...</span> <span class="o">...</span>
        <span class="mi">400</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Bad Request&#39;</span><span class="p">,</span>
              <span class="s">&#39;Bad request syntax or unsupported method&#39;</span><span class="p">),</span>
        <span class="o">...</span> <span class="o">...</span>
        <span class="mi">500</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="s">&#39;Server got itself in trouble&#39;</span><span class="p">),</span>
        <span class="o">...</span> <span class="o">...</span>
        <span class="p">}</span>
</pre></div>
</td></tr></table><div class="section" id="url">
<h3><a class="toc-backref" href="#id16">URL 长度限制 </a></h3>
<p>HTTP 协议规范里面貌似没有对 URL 的长度做出限制，但是各家浏览器以及 Web 服务器在实现时，都对 URL 的长度做了不同程序的限制。</p>
<p> 本模块的代码也对 URL 的长度做了限制，大概 65530 左右的样子 ( 该值不确定，因为代码中只对第一行进行了长度判断 )。</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id17"> 打印日志的相关方法 </a></h3>
<p> 上面的代码中有很多是有关打印日志的，该日志多用于调试。</p>
<p> 其实这些方法最好单独整一个类出来存放，因为这方法并不是 <cite>BaseHTTPRequestHandler</cite> 的主要功能代码。</p>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p> 由于日志中会获取客户端的主机名等信息，可能会有 DNS 解析过慢的问题。</p>
<p> 所以在正式使用时一定要关闭日志的输出功能，比如重载 <cite>log_message</cite> 方法。</p>
<div class="last"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="responses">
<h3><a class="toc-backref" href="#id18">responses</a></h3>
<p> 罗列了 <a class="reference external" href="http://datatracker.ietf.org/doc/rfc2616/">RFC 2616</a>  中定义的 HTTP 返回码及其说明。</p>
<p> 其格式为 <cite>{HTTP 返回码 : ( 简短说明，详细说明 )}</cite></p>
</div>
</div>

            
            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://chenjiee815.github.io/basehttpserverbiao-zhun-ku-yuan-ma-xue-xi.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'chenjiee815blog';
        var disqus_identifier = 'http://chenjiee815.github.io/basehttpserverbiao-zhun-ku-yuan-ma-xue-xi.html';
    var disqus_url = 'http://chenjiee815.github.io/basehttpserverbiao-zhun-ku-yuan-ma-xue-xi.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-11-20T09:48:13.476432">Nov 20, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="http://chenjiee815.github.io/categories.html#python-ref">Python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://chenjiee815.github.io/tags.html#python-ref">python
                    <span>19</span>
</a></li>
                <li><a href="http://chenjiee815.github.io/tags.html#stdlibs-ref">stdlibs
                    <span>11</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://www.htdp.org/" title="My HTDP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-htdp sidebar-social-links"></i></a>
    <a href="http://mitpress.mit.edu/sicp/" title="My SICP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-sicp sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>

                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'chenjiee815blog';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>