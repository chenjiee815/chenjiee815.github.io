<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Chen Jie" />
        <meta name="copyright" content="Chen Jie" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="python, stdlibs, Python, " />

<meta property="og:title" content="StringIO标准库源码学习 "/>
<meta property="og:url" content="/stringiobiao-zhun-ku-yuan-ma-xue-xi.html" />
<meta property="og:description" content="简介 StringIO 有一个 C 语言实现的版本 cStringIO 。 C 语言版本更快，但不是能创建子类，因为 C 语言版本实现为一个方法了。 StringIO 主要是用来模拟一个 file 对象的行为的。 代码注释里说 Using a real file is often faster (but less convenient). 之前我还困惑 StringIO 不是相当于一个内存对象么，真实的文件对象需要操作磁盘啊，怎么反而更快？ 后来我在 Stack Overflow 上问一下，原来是指代码执行的速度， Python 的内置文件对象是用 C 语言实现的。而 StringIO 是用 Python 代码实现的，当然慢了。 代码注释里还说 Seeking far ..." />
<meta property="og:site_name" content="January Star" />
<meta property="og:article:author" content="Chen Jie" />
<meta property="og:article:published_time" content="2014-09-01T15:00:04.225133" />
<meta name="twitter:title" content="StringIO标准库源码学习 ">
<meta name="twitter:description" content="简介 StringIO 有一个 C 语言实现的版本 cStringIO 。 C 语言版本更快，但不是能创建子类，因为 C 语言版本实现为一个方法了。 StringIO 主要是用来模拟一个 file 对象的行为的。 代码注释里说 Using a real file is often faster (but less convenient). 之前我还困惑 StringIO 不是相当于一个内存对象么，真实的文件对象需要操作磁盘啊，怎么反而更快？ 后来我在 Stack Overflow 上问一下，原来是指代码执行的速度， Python 的内置文件对象是用 C 语言实现的。而 StringIO 是用 Python 代码实现的，当然慢了。 代码注释里还说 Seeking far ...">

        <title>StringIO标准库源码学习  · January Star
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52167018-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="/"><span class=site-name>January Star</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="">Home</a></li>
                            <li ><a href="/categories.html">Categories</a></li>
                            <li ><a href="/tags.html">Tags</a></li>
                            <li ><a href="/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="/stringiobiao-zhun-ku-yuan-ma-xue-xi.html"> StringIO标准库源码学习  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id3"> 简介 </a></li>
<li><a class="reference internal" href="#complain-ifclosed" id="id4">_complain_ifclosed</a></li>
<li><a class="reference internal" href="#id2" id="id5">StringIO</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            
<hr class="docutils"/>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id3"> 简介 </a></h2>
<p><cite>StringIO</cite> 有一个 C 语言实现的版本 <cite>cStringIO</cite> 。</p>
<p>C 语言版本更快，但不是能创建子类，因为 C 语言版本实现为一个方法了。</p>
<p><cite>StringIO</cite> 主要是用来模拟一个 <cite>file</cite> 对象的行为的。</p>
<p> 代码注释里说 </p>
<pre class="literal-block">
Using a real file is often faster (but less convenient).
</pre>
<p> 之前我还困惑 <cite>StringIO</cite> 不是相当于一个内存对象么，真实的文件对象需要操作磁盘啊，怎么反而更快？</p>
<p> 后来我在 <cite>Stack Overflow</cite> 上问一下，原来是指代码执行的速度， Python 的内置文件对象是用 C 语言实现的。而 <cite>StringIO</cite> 是用 Python 代码实现的，当然慢了。</p>
<p> 代码注释里还说 </p>
<pre class="literal-block">
Seeking far beyond EOF and then writing will
insert real null bytes that occupy space in the buffer.
</pre>
<p> 这个好理解，我直接上代码就清楚了。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">130</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">131</span><span class="p">]:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="s">"abc"</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">132</span><span class="p">]:</span> <span class="n">s</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">133</span><span class="p">]:</span> <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"end"</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">134</span><span class="p">]:</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">134</span><span class="p">]:</span> <span class="s">'abc</span><span class="se">\x00\x00\x00\x00\x00\x00\x00</span><span class="s">end'</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="complain-ifclosed">
<h2><a class="toc-backref" href="#id4">_complain_ifclosed</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">_complain_ifclosed</span><span class="p">(</span><span class="n">closed</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">"I/O operation on closed file"</span>
</pre></div>
</td></tr></table><p> 这个方法是 <cite>StringIO</cite> 的辅助方法，用来检查当前操作的 <cite>StringIO</cite> 是否已经关闭，如果关闭，则直接抛出异常。</p>
<p> 在接下来的代码中，你会看到在多个方法里面手工调用该函数。</p>
<p> 其实，这里可以考虑先定义一个元类，针对那些需要调用该函数的方法，先在元类里面就统一调用一下，那么 <cite>StringIO</cite> 就不用关心当前的状态是否为开还是关了。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ClosedStatusChecker</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
       <span class="nb">super</span><span class="p">(</span><span class="n">ClosedStatusChecker</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
       <span class="n">need_check_funcs</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"need_check_funcs"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">need_check_funcs</span><span class="p">:</span>
           <span class="k">def</span> <span class="nf">check_func</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
               <span class="k">def</span> <span class="nf">_check_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">"I/O operation on closed file"</span><span class="p">)</span>
                   <span class="k">return</span> <span class="n">dct</span><span class="p">[</span><span class="n">fname</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
               <span class="k">return</span> <span class="n">_check_func</span>
           <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">need_check_funcs</span><span class="p">:</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">check_func</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">StringIO</span><span class="p">:</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ClosedStatusChecker</span>
    <span class="n">need_check_funcs</span> <span class="o">=</span> <span class="p">(</span><span class="s">"next"</span><span class="p">,</span> <span class="s">"isatty"</span><span class="p">,</span> <span class="o">...</span> <span class="o">...</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="s">''</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softspace</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="o">...</span> <span class="o">...</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id5">StringIO</a></h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StringIO</span><span class="p">:</span>
    <span class="sd">"""class StringIO([buffer])</span>

<span class="sd">    使用 StringIO 时要注意：不能混用 Unicode 字符串和 8 字节字符串。</span>

<span class="sd">    虽然 StringIO 对它们都支持，但是是同时只能支持一种。</span>

<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span> <span class="o">=</span> <span class="s">''</span><span class="p">):</span>
        <span class="c"># 如果传入的不是一个字符串，直接简单粗暴地将之转换成字符串 </span>
        <span class="c"># 刚开始看到这个 buffer，还以为可以传入一个生成字符串的生成器什么的 </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softspace</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 这个不用解释了，迭代器协议要求的接口 </span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 这个也是迭代器协议要求的接口，</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Free the memory buffer.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

    <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Returns False because StringIO objects are not connected to a</span>
<span class="sd">        tty-like device.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">"""Set the file's current position.</span>

<span class="sd">        The mode argument is optional and defaults to 0 (absolute file</span>
<span class="sd">        positioning); other values are 1 (seek relative to the current</span>
<span class="sd">        position) and 2 (seek relative to the file's end).</span>

<span class="sd">        There is no return value.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return the file's current position."""</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">"""Read at most size bytes from the file</span>
<span class="sd">        (less if the read hits EOF before obtaining size bytes).</span>

<span class="sd">        If the size argument is negative or omitted, read all data until EOF</span>
<span class="sd">        is reached. The bytes are returned as a string object. An empty</span>
<span class="sd">        string is returned when EOF is encountered immediately.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newpos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">+</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span><span class="n">newpos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">newpos</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">r"""Read one entire line from the file.</span>

<span class="sd">        A trailing newline character is kept in the string (but may be absent</span>
<span class="sd">        when a file ends with an incomplete line). If the size argument is</span>
<span class="sd">        present and non-negative, it is a maximum byte count (including the</span>
<span class="sd">        trailing newline) and an incomplete line may be returned.</span>

<span class="sd">        An empty string is returned only when EOF is encountered immediately.</span>

<span class="sd">        Note: Unlike stdio's fgets(), the returned string contains null</span>
<span class="sd">        characters ('\0') if they occurred in the input.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newpos</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">newpos</span><span class="p">:</span>
                <span class="n">newpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">length</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span><span class="n">newpos</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">newpos</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">"""Read until EOF using readline() and return a list containing the</span>
<span class="sd">        lines thus read.</span>

<span class="sd">        If the optional sizehint argument is present, instead of reading up</span>
<span class="sd">        to EOF, whole lines totalling approximately sizehint bytes (or more</span>
<span class="sd">        to accommodate a final whole line).</span>
<span class="sd">        """</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lines</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">"""Truncate the file's size.</span>

<span class="sd">        If the optional size argument is present, the file is truncated to</span>
<span class="sd">        (at most) that size. The size defaults to the current position.</span>
<span class="sd">        The current file position is not changed unless the position</span>
<span class="sd">        is beyond the new file size.</span>

<span class="sd">        If the specified size exceeds the file's current size, the</span>
<span class="sd">        file remains unchanged.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">elif</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">"Negative size not allowed"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()[:</span><span class="n">size</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">"""Write a string to the file.</span>

<span class="sd">        There is no return value.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>
        <span class="c"># Force s to be a string or unicode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">spos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">slen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span>
        <span class="k">if</span> <span class="n">spos</span> <span class="o">==</span> <span class="n">slen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">spos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">spos</span> <span class="o">&gt;</span> <span class="n">slen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'</span><span class="se">\0</span><span class="s">'</span><span class="o">*</span><span class="p">(</span><span class="n">spos</span> <span class="o">-</span> <span class="n">slen</span><span class="p">))</span>
            <span class="n">slen</span> <span class="o">=</span> <span class="n">spos</span>
        <span class="n">newpos</span> <span class="o">=</span> <span class="n">spos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spos</span> <span class="o">&lt;</span> <span class="n">slen</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span><span class="n">spos</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">newpos</span><span class="p">:]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s">''</span>
            <span class="k">if</span> <span class="n">newpos</span> <span class="o">&gt;</span> <span class="n">slen</span><span class="p">:</span>
                <span class="n">slen</span> <span class="o">=</span> <span class="n">newpos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">slen</span> <span class="o">=</span> <span class="n">newpos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">slen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">newpos</span>

    <span class="k">def</span> <span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="sd">"""Write a sequence of strings to the file. The sequence can be any</span>
<span class="sd">        iterable object producing strings, typically a list of strings. There</span>
<span class="sd">        is no return value.</span>

<span class="sd">        (The name is intended to match readlines(); writelines() does not add</span>
<span class="sd">        line separators.)</span>
<span class="sd">        """</span>
        <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Flush the internal buffer</span>
<span class="sd">        """</span>
        <span class="c"># StringIO 压根不用操作磁盘，所以没有 flush 操作 </span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Retrieve the entire contents of the "file" at any time before</span>
<span class="sd">        the StringIO object's close() method is called.</span>

<span class="sd">        The StringIO object can accept either Unicode or 8-bit strings,</span>
<span class="sd">        but mixing the two may take some care. If both are used, 8-bit</span>
<span class="sd">        strings that cannot be interpreted as 7-bit ASCII (that use the</span>
<span class="sd">        8th bit) will cause a UnicodeError to be raised when getvalue()</span>
<span class="sd">        is called.</span>
<span class="sd">        """</span>
        <span class="n">_complain_ifclosed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buflist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buflist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buf</span>
</pre></div>
</td></tr></table></div>

            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-09-01T15:00:04.225133">Sep 1, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#python-ref">Python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#python-ref">python
                    <span>10</span>
</a></li>
                <li><a href="/tags.html#stdlibs-ref">stdlibs
                    <span>4</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://www.htdp.org/" title="My HTDP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-htdp sidebar-social-links"></i></a>
    <a href="http://mitpress.mit.edu/sicp/" title="My SICP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-sicp sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>

                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>