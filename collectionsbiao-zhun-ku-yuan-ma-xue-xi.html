<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Chen Jie" />
        <meta name="copyright" content="Chen Jie" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="python, stdlibs, Python, " />

<meta property="og:title" content="collections标准库源码学习 "/>
<meta property="og:url" content="http://chenjiee815.github.io/collectionsbiao-zhun-ku-yuan-ma-xue-xi.html" />
<meta property="og:description" content="简介 collections 库包含两个文件 collections.py 和 _abcoll.py 。 至于为什么要拆分成两个文件， collections 库在文件一开始就在注释里写到： For bootstrapping reasons, the collection ABCs are defined in _abcoll.py. They should however be considered an integral part of collections.py. 我刚开始找不出它这个 bootstrapping reasons, 后来 google 了一下，发现这个 bootstrapping reasons 的解释。 不过这个链接里说 collections 会引用 os ， 而 os 又会引用 ..." />
<meta property="og:site_name" content="January Star" />
<meta property="og:article:author" content="Chen Jie" />
<meta property="og:article:published_time" content="2014-09-03T11:23:37.401731" />
<meta name="twitter:title" content="collections标准库源码学习 ">
<meta name="twitter:description" content="简介 collections 库包含两个文件 collections.py 和 _abcoll.py 。 至于为什么要拆分成两个文件， collections 库在文件一开始就在注释里写到： For bootstrapping reasons, the collection ABCs are defined in _abcoll.py. They should however be considered an integral part of collections.py. 我刚开始找不出它这个 bootstrapping reasons, 后来 google 了一下，发现这个 bootstrapping reasons 的解释。 不过这个链接里说 collections 会引用 os ， 而 os 又会引用 ...">

        <title>collections标准库源码学习  · January Star
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52167018-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://chenjiee815.github.io/"><span class=site-name>January Star</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://chenjiee815.github.io">Home</a></li>
                            <li ><a href="http://chenjiee815.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://chenjiee815.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://chenjiee815.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://chenjiee815.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://chenjiee815.github.io/collectionsbiao-zhun-ku-yuan-ma-xue-xi.html"> collections标准库源码学习  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id10"> 简介 </a></li>
<li><a class="reference internal" href="#ordereddict" id="id11">OrderedDict</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            
<hr class="docutils"/>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id10"> 简介 </a></h2>
<p><cite>collections</cite> 库包含两个文件 <cite>collections.py</cite> 和  <cite>_abcoll.py</cite> 。</p>
<p> 至于为什么要拆分成两个文件， <cite>collections</cite> 库在文件一开始就在注释里写到：</p>
<pre class="literal-block">
For bootstrapping reasons, the collection ABCs are defined in _abcoll.py.
They should however be considered an integral part of collections.py.
</pre>
<p> 我刚开始找不出它这个 bootstrapping reasons, 后来 google 了一下，发现这个 <a class="reference external" href="http://stackoverflow.com/questions/12141229/about-the-code-comments-for-bootstrapping-issues-in-collections-py-and-abcoll-p">bootstrapping reasons</a> 的解释。</p>
<p> 不过这个链接里说 <cite>collections</cite> 会引用 <cite>os</cite> ， 而 <cite>os</cite> 又会引用 <cite>_abcoll</cite> ，如果 <cite>collections</cite> 和 <cite>_abcoll</cite> 的代码在一起，会造成循环引用。</p>
<p> 但是我代码看了头天也没发现 <cite>collections.py</cite> 文件中有 <cite>import os</cite> 的地方。</p>
<p> 好吧，这个问题咱先不追究了，还是分析主要代码要紧。</p>
</div>
<div class="section" id="ordereddict">
<h2><a class="toc-backref" href="#id11">OrderedDict</a></h2>
<p><cite>OrderedDict</cite> ，一看名字就知道，它会记住每个 Key 的插入顺序。当然，它还是一个 <cite>dict</cite> ，所以从 <cite>dict</cite> 继承也是理所当然的。</p>
<p> 它只从 <cite>dict</cite> 类继承了 <cite>__getitem__</cite> 、 <cite>__len__</cite> 、 <cite>__contains__</cite> 和 <cite>get</cite> 。其它的操作都是顺序敏感的，所以需要重载。</p>
<p> 它的时间复杂度还是和 <cite>dict</cite> 是一样的。</p>
<p> 具体实现思路是 :</p>
<blockquote>
<p> 用双端循环链表来保存 Key 值 , 其中每个节点为 [PREV, NEXT, KEY],
该链表初始化时有一个哨兵节点 , 该节点永远不会被删除 ( 这样算法实现起来简单一点 ).</p>
<p> 使用 self.__map 来保存 Key 值和对应的双端循环链表中的节点的映射关系 .</p>
<p> 使用继承的 dict 功能来保存 Key 和对应 Value 的映射关系 .</p>
</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 51)</p>
<p>Content block expected for the "code-block" directive; none found.</p>
<pre class="literal-block">
.. code-block:: python

</pre>
</div>
<dl class="docutils">
<dt>class OrderedDict(dict):</dt>
<dd><dl class="first docutils">
<dt>def __init__(self, <a href="#id2"><span class="problematic" id="id3">*</span></a>args, <a href="#id4"><span class="problematic" id="id5">**</span></a>kwds):</dt>
<dd><div class="first system-message" id="id2">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 68); <em><a href="#id3">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
<div class="system-message" id="id4">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 68); <em><a href="#id5">backlink</a></em></p>
Inline strong start-string without end-string.</div>
<p>""" 这里虽然提供了 <cite>kwds</cite> ，但是不建议传入多个命名参数
因为这些参数的顺序是随意的，不是按照你传入的顺序来的
"""
if len(args) &gt; 1:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 59)</p>
Unexpected indentation.</div>
<blockquote>
raise TypeError('expected at most 1 arguments, got %d' % len(args))</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 60)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<dl class="docutils">
<dt>try:</dt>
<dd>self.__root</dd>
<dt>except AttributeError:</dt>
<dd># 哨兵元素
self.__root = root = []
# 双端循环链表
root[:] = [root, root, None]
self.__map = {}</dd>
</dl>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 68)</p>
Definition list ends without a blank line; unexpected unindent.</div>
<p>self.__update(<a href="#id6"><span class="problematic" id="id7">*</span></a>args, <a href="#id8"><span class="problematic" id="id9">**</span></a>kwds)</p>
<div class="system-message" id="id6">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 68); <em><a href="#id7">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
<div class="last system-message" id="id8">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 68); <em><a href="#id9">backlink</a></em></p>
Inline strong start-string without end-string.</div>
</dd>
<dt>def __setitem__(self, key, value, dict_setitem=dict.__setitem__):</dt>
<dd><p class="first">'od.__setitem__(i, y) &lt;==&gt; od[i]=y'
if key not in self:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 73)</p>
Unexpected indentation.</div>
<blockquote>
# 向链表中插入新的 Key 节点
# self.__map 中添加 Key 和 Key 节点的映射关系
root = self.__root
last = root[0]
last[1] = root[0] = self.__map[key] = [last, root, key]</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 78)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p class="last"># 使用继承的 dict 功能来保存 Key 和对应 Value 的映射关系
return dict_setitem(self, key, value)</p>
</dd>
<dt>def __delitem__(self, key, dict_delitem=dict.__delitem__):</dt>
<dd>'od.__delitem__(y) &lt;==&gt; del od[y]'
dict_delitem(self, key)
# 先从映射关系中根据 Key 找到 Key 节点 , 然后再删除双端循环列表对应的 Key 节点
link_prev, link_next, _ = self.__map.pop(key)
link_prev[1] = link_next                        # update link_prev[NEXT]
link_next[0] = link_prev                        # update link_next[PREV]</dd>
<dt>def __iter__(self):</dt>
<dd><p class="first">'od.__iter__() &lt;==&gt; iter(od)'
# Traverse the linked list in order.
root = self.__root
curr = root[1]                                  # start at the first node
while curr is not root:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 95)</p>
Unexpected indentation.</div>
<blockquote class="last">
yield curr[2]                               # yield the curr[KEY]
curr = curr[1]                              # move to next node</blockquote>
</dd>
<dt>def __reversed__(self):</dt>
<dd><p class="first">'od.__reversed__() &lt;==&gt; reversed(od)'
# Traverse the linked list in reverse order.
root = self.__root
curr = root[0]                                  # start at the last node
while curr is not root:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 104)</p>
Unexpected indentation.</div>
<blockquote class="last">
yield curr[2]                               # yield the curr[KEY]
curr = curr[0]                              # move to previous node</blockquote>
</dd>
<dt>def clear(self):</dt>
<dd>'od.clear() -&gt; None.  Remove all items from od.'
root = self.__root
root[:] = [root, root, None]
self.__map.clear()
dict.clear(self)</dd>
</dl>
<p># 以下的操作方法 , 都不依赖于对链表和 self.__map 的操作了
# 可以说上面那些方法是底层 API, 下面的是高层 API
def keys(self):</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 117)</p>
Unexpected indentation.</div>
<blockquote>
'od.keys() -&gt; list of keys in od'
return list(self)</blockquote>
<dl class="docutils">
<dt>def values(self):</dt>
<dd>'od.values() -&gt; list of values in od'
return [self[key] for key in self]</dd>
<dt>def items(self):</dt>
<dd>'od.items() -&gt; list of (key, value) pairs in od'
return [(key, self[key]) for key in self]</dd>
<dt>def iterkeys(self):</dt>
<dd>'od.iterkeys() -&gt; an iterator over the keys in od'
return iter(self)</dd>
<dt>def itervalues(self):</dt>
<dd><p class="first">'od.itervalues -&gt; an iterator over the values in od'
for k in self:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 135)</p>
Unexpected indentation.</div>
<blockquote class="last">
yield self[k]</blockquote>
</dd>
<dt>def iteritems(self):</dt>
<dd><p class="first">'od.iteritems -&gt; an iterator over the (key, value) pairs in od'
for k in self:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 140)</p>
Unexpected indentation.</div>
<blockquote class="last">
yield (k, self[k])</blockquote>
</dd>
</dl>
<p>update = MutableMapping.update</p>
<p># 再命名一个 <cite>__update</cite> 是专门给 __init__ 用的
# 不然，用户继承该类并重载了 __update，就对该类产生了破坏
__update = update</p>
<p># 该 Object 实例在 Python 中是独一无二的
__marker = object()</p>
<dl class="docutils">
<dt>def pop(self, key, default=__marker):</dt>
<dd><p class="first">'''od.pop(k[,d]) -&gt; v, remove specified key and return the corresponding
value.  If key is not found, d is returned if given, otherwise KeyError
is raised.</p>
<p>'''
if key in self:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 158)</p>
Unexpected indentation.</div>
<blockquote>
result = self[key]
del self[key]
return result</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 161)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<dl class="docutils">
<dt>if default is self.__marker:</dt>
<dd>raise KeyError(key)</dd>
</dl>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 163)</p>
Definition list ends without a blank line; unexpected unindent.</div>
<p class="last">return default</p>
</dd>
<dt>def setdefault(self, key, default=None):</dt>
<dd><p class="first">'od.setdefault(k[,d]) -&gt; od.get(k,d), also set od[k]=d if k not in od'
if key in self:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 168)</p>
Unexpected indentation.</div>
<blockquote>
return self[key]</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 169)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p class="last">self[key] = default
return default</p>
</dd>
<dt>def popitem(self, last=True):</dt>
<dd><p class="first">'''od.popitem() -&gt; (k, v), return and remove a (key, value) pair.
Pairs are returned in LIFO order if last is true or FIFO order if false.</p>
<p>'''
if not self:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 178)</p>
Unexpected indentation.</div>
<blockquote>
raise KeyError('dictionary is empty')</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 179)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p class="last">key = next(reversed(self) if last else iter(self))
value = self.pop(key)
return key, value</p>
</dd>
<dt>def __repr__(self, _repr_running={}):</dt>
<dd><p class="first">'od.__repr__() &lt;==&gt; repr(od)'
call_key = id(self), _get_ident()
if call_key in _repr_running:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 187)</p>
Unexpected indentation.</div>
<blockquote>
return '...'</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 188)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p>_repr_running[call_key] = 1
try:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 190)</p>
Unexpected indentation.</div>
<blockquote>
<dl class="docutils">
<dt>if not self:</dt>
<dd>return '%s()' % (self.__class__.__name__,)</dd>
</dl>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 192)</p>
Definition list ends without a blank line; unexpected unindent.</div>
<p>return '%s(%r)' % (self.__class__.__name__, self.items())</p>
</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 193)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<dl class="last docutils">
<dt>finally:</dt>
<dd>del _repr_running[call_key]</dd>
</dl>
</dd>
<dt>def __reduce__(self):</dt>
<dd><p class="first"> 可以让 Pickle 进行序列化和反序列化
items = [[k, self[k]] for k in self]
inst_dict = vars(self).copy()
for k in vars(OrderedDict()):</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 201)</p>
Unexpected indentation.</div>
<blockquote>
inst_dict.pop(k, None)</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 202)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<dl class="docutils">
<dt>if inst_dict:</dt>
<dd>return (self.__class__, (items,), inst_dict)</dd>
</dl>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 204)</p>
Definition list ends without a blank line; unexpected unindent.</div>
<p class="last">return self.__class__, (items,)</p>
</dd>
<dt>def copy(self):</dt>
<dd>'od.copy() -&gt; a shallow copy of od'
return self.__class__(self)</dd>
</dl>
<p>@classmethod
def fromkeys(cls, iterable, value=None):</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 212)</p>
Unexpected indentation.</div>
<blockquote>
<p>'''OD.fromkeys(S[, v]) -&gt; New ordered dictionary with keys from S.
If not specified, the value defaults to None.</p>
<p>'''
self = cls()
for key in iterable:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 218)</p>
Unexpected indentation.</div>
<blockquote>
self[key] = value</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 219)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p>return self</p>
</blockquote>
<dl class="docutils">
<dt>def __eq__(self, other):</dt>
<dd><p class="first">'''od.__eq__(y) &lt;==&gt; od==y.  Comparison to another OD is order-sensitive
while comparison to a regular mapping is order-insensitive.</p>
<p>'''
if isinstance(other, OrderedDict):</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 227)</p>
Unexpected indentation.</div>
<blockquote>
return dict.__eq__(self, other) and all(_imap(_eq, self, other))</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/media/cj/self/git/chenjiee815_blogs/chenjiee815_blogs/content/python/stdlibs/collections.rst</tt>, line 228)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p class="last">return dict.__eq__(self, other)</p>
</dd>
<dt>def __ne__(self, other):</dt>
<dd>'od.__ne__(y) &lt;==&gt; od!=y'
return not self == other</dd>
</dl>
<p># -- the following methods support python 3.x style dictionary views --</p>
<dl class="last docutils">
<dt>def viewkeys(self):</dt>
<dd>"od.viewkeys() -&gt; a set-like object providing a view on od's keys"
return KeysView(self)</dd>
<dt>def viewvalues(self):</dt>
<dd>"od.viewvalues() -&gt; an object providing a view on od's values"
return ValuesView(self)</dd>
<dt>def viewitems(self):</dt>
<dd>"od.viewitems() -&gt; a set-like object providing a view on od's items"
return ItemsView(self)</dd>
</dl>
</dd>
</dl>
<p> 上面的底层 API 可以将双端循环链表抽象出来 </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DoubleLink</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">""" 双端循环链表 """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DoubleLink</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__root</span> <span class="o">=</span> <span class="n">root</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">root</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">root</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c"># 每次都是在哨兵节点的前面插入一个新的节点 </span>
        <span class="c"># 每次插入的节点逻辑上为最后一个节点 </span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">prev</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span>
        <span class="nb">next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root</span> <span class="c"># 哨兵节点不用参与遍历 </span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                                  <span class="c"># start at the first node</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">curr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>                               <span class="c"># yield the curr[KEY]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                              <span class="c"># move to next node</span>

    <span class="k">def</span> <span class="nf">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root</span> <span class="c"># 哨兵节点不用参与遍历 </span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                  <span class="c"># start at the last node</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">curr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>                               <span class="c"># yield the curr[KEY]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                              <span class="c"># move to previous node</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root</span>
        <span class="c"># 这一行 , 猛一看还以为写错了 </span>
        <span class="c"># 后来仔细想了一下 , [root, root, None] 中的 root 其实是一个引用 ( 引用本身不保存任何值 , 相当于指针 )</span>
        <span class="c"># 当赋值给 root[:] 时 , 直接清除了 root 中原来保存的值 </span>
        <span class="c"># 直接变成 [root 引用 , root 引用 , None]</span>
        <span class="n">root</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">root</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">OrderedDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">'expected at most 1 arguments, got </span><span class="si">%d</span><span class="s">'</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dl</span> <span class="o">=</span> <span class="n">DoubleLink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dict_setitem</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dl</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_setitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dict_delitem</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">):</span>
        <span class="s">'od.__delitem__(y) &lt;==&gt; del od[y]'</span>
        <span class="n">dict_delitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dl</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">__iter__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dl</span><span class="o">.</span><span class="n">__iter__</span>

    <span class="n">__reversed__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dl</span><span class="o">.</span><span class="n">__reversed__</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dl</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="o">...</span> <span class="o">...</span>
</pre></div>
</td></tr></table></div>

            
            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://chenjiee815.github.io/collectionsbiao-zhun-ku-yuan-ma-xue-xi.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'chenjiee815blog';
        var disqus_identifier = 'http://chenjiee815.github.io/collectionsbiao-zhun-ku-yuan-ma-xue-xi.html';
    var disqus_url = 'http://chenjiee815.github.io/collectionsbiao-zhun-ku-yuan-ma-xue-xi.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-09-03T11:23:37.401731">Sep 3, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="http://chenjiee815.github.io/categories.html#python-ref">Python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://chenjiee815.github.io/tags.html#python-ref">python
                    <span>11</span>
</a></li>
                <li><a href="http://chenjiee815.github.io/tags.html#stdlibs-ref">stdlibs
                    <span>5</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://www.htdp.org/" title="My HTDP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-htdp sidebar-social-links"></i></a>
    <a href="http://mitpress.mit.edu/sicp/" title="My SICP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-sicp sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>

                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'chenjiee815blog';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>