<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Chen Jie" />
        <meta name="copyright" content="Chen Jie" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="python, stdlibs, Python, " />

<meta property="og:title" content="fnmatch标准库源码学习 "/>
<meta property="og:url" content="http://chenjiee815.github.io/fnmatchbiao-zhun-ku-yuan-ma-xue-xi.html" />
<meta property="og:description" content="Contents 简介 translate fnmatch&amp;&amp;fnmatchcase filter 总结 简介 fnmatch 库的还是很简单的，代码加注释才 100 行多一点。 它主要做的工作就是比较一个给定的文件名和给定的模式字符串，判断两者是否相等。 然后围绕这个功能，提供一系列的相关函数。 filter 输入 一个文件名列表和一个指定模式（仅支持 Shell 通配符） 输出 一个符合指定模式的文件名列表 fnmatch 输入 一个文件名和一个指定模式（仅支持 Shell 通配符） 输出 该文件名是否匹配指定模式 说明 具体行为和平台相关，比如某些平台忽略大小写等等 fnmatchcase 输入 一个文件名和一个指定模式（仅支持 Shell 通配符） 输出 该文件名是否匹配指定模式 说明 大小写敏感 translate 输入 Shell 通配符格式的模式字符串 ..." />
<meta property="og:site_name" content="January Star" />
<meta property="og:article:author" content="Chen Jie" />
<meta property="og:article:published_time" content="2014-09-01T22:56:11.432803" />
<meta name="twitter:title" content="fnmatch标准库源码学习 ">
<meta name="twitter:description" content="Contents 简介 translate fnmatch&amp;&amp;fnmatchcase filter 总结 简介 fnmatch 库的还是很简单的，代码加注释才 100 行多一点。 它主要做的工作就是比较一个给定的文件名和给定的模式字符串，判断两者是否相等。 然后围绕这个功能，提供一系列的相关函数。 filter 输入 一个文件名列表和一个指定模式（仅支持 Shell 通配符） 输出 一个符合指定模式的文件名列表 fnmatch 输入 一个文件名和一个指定模式（仅支持 Shell 通配符） 输出 该文件名是否匹配指定模式 说明 具体行为和平台相关，比如某些平台忽略大小写等等 fnmatchcase 输入 一个文件名和一个指定模式（仅支持 Shell 通配符） 输出 该文件名是否匹配指定模式 说明 大小写敏感 translate 输入 Shell 通配符格式的模式字符串 ...">

        <title>fnmatch标准库源码学习  · January Star
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://chenjiee815.github.io/theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52167018-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://chenjiee815.github.io/"><span class=site-name>January Star</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://chenjiee815.github.io">Home</a></li>
                            <li ><a href="http://chenjiee815.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://chenjiee815.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://chenjiee815.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://chenjiee815.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://chenjiee815.github.io/fnmatchbiao-zhun-ku-yuan-ma-xue-xi.html"> fnmatch标准库源码学习  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id3"> 简介 </a></li>
<li><a class="reference internal" href="#translate" id="id4">translate</a></li>
<li><a class="reference internal" href="#fnmatch-fnmatchcase" id="id5">fnmatch&amp;&amp;fnmatchcase</a></li>
<li><a class="reference internal" href="#filter" id="id6">filter</a></li>
<li><a class="reference internal" href="#id2" id="id7"> 总结 </a></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id3"> 简介 </a></h2>
<p>fnmatch 库的还是很简单的，代码加注释才 100 行多一点。</p>
<p> 它主要做的工作就是比较一个给定的文件名和给定的模式字符串，判断两者是否相等。</p>
<p> 然后围绕这个功能，提供一系列的相关函数。</p>
<ul>
<li><p class="first">filter</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="92%" />
</colgroup>
<tbody valign="top">
<tr><td> 输入 </td>
<td> 一个文件名列表和一个指定模式（仅支持 Shell 通配符）</td>
</tr>
<tr><td> 输出 </td>
<td> 一个符合指定模式的文件名列表 </td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">fnmatch</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="92%" />
</colgroup>
<tbody valign="top">
<tr><td> 输入 </td>
<td> 一个文件名和一个指定模式（仅支持 Shell 通配符）</td>
</tr>
<tr><td> 输出 </td>
<td> 该文件名是否匹配指定模式 </td>
</tr>
<tr><td> 说明 </td>
<td> 具体行为和平台相关，比如某些平台忽略大小写等等 </td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">fnmatchcase</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="92%" />
</colgroup>
<tbody valign="top">
<tr><td> 输入 </td>
<td> 一个文件名和一个指定模式（仅支持 Shell 通配符）</td>
</tr>
<tr><td> 输出 </td>
<td> 该文件名是否匹配指定模式 </td>
</tr>
<tr><td> 说明 </td>
<td> 大小写敏感 </td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">translate</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<tbody valign="top">
<tr><td> 输入 </td>
<td>Shell 通配符格式的模式字符串 </td>
</tr>
<tr><td> 输出 </td>
<td> 正则格式的模式字符串 </td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
<div class="section" id="translate">
<h2><a class="toc-backref" href="#id4">translate</a></h2>
<p> 至于如何判断两者相等，它的做法是：</p>
<blockquote>
使用 <strong> 正则表达式 </strong></blockquote>
<p> 既然要使用 <strong> 正则表达式 </strong> ，那么就要考虑如何将通配符表达式替换成正则表达式。</p>
<p> 这个功能就是由 <cite>translate</cite> 函数来实现的。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">ntranslate</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translate a shell PATTERN to a regular expression.</span>

<span class="sd">    There is no way to quote meta-characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#39;.*&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;!&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;]&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">pat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;]&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">[&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stuff</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">stuff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;!&#39;</span><span class="p">:</span>
                    <span class="n">stuff</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">stuff</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">stuff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;^&#39;</span><span class="p">:</span>
                    <span class="n">stuff</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">stuff</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">stuff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#39;\Z(?ms)&#39;</span>
</pre></div>
</td></tr></table><p> 上面的代码明显是命令式编程的思路。那我想换一种思路，用函数式编程来重写这个函数。</p>
<p> 我们首先会考虑这个 <cite>translate</cite> 函数的基本功能是什么？</p>
<blockquote>
将通配符表达式转换成正则表达式。</blockquote>
<p> 那么它们俩的区别是什么？</p>
<blockquote>
<p> 通配符表达式的 <cite>*</cite> 在正则表达式中为 <cite>.*</cite></p>
<p> 通配符表达式的 <cite>?</cite> 在正则表达式中为 <cite>.</cite></p>
<p> 通配符表达式的 <cite>[XXX]</cite> 在正则表达式中为 <cite>[XXX]</cite></p>
<p> 通配符表达式的 <cite>[!XXX]</cite> 、 <cite>[^XXX]</cite> 在正则表达式中为 <cite>[^XXX]</cite></p>
<p> 通配符表达式的其它字符， 在正则表达式中都需要 re.escape 进行转义 </p>
</blockquote>
<p> 好的，上面分析的几种情况，都可以通过首个字符来判断其接下来的处理属于哪一类，但是 <cite>[XXX]</cite> 这种类型，还要包括后面的好几个字符，所以处理完这种类型需要知道剩下的未处理字符串。</p>
<p> 大家都统一一下接口就提取出如下几个辅助函数：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">trans_default</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">:</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">left_pat</span><span class="p">)</span>
<span class="n">trans_asterisk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;.*&#39;</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span>
<span class="n">trans_questionmark</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">trans_choice</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">):</span>
    <span class="c"># 这个函数最初也是用递归实现，然后再转换成 while 循环 </span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">left_pat</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">while</span> <span class="n">left_pat</span><span class="p">:</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">left_pat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">left_pat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="s">&#39;^&#39;</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">^&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;]&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="s">&#39;]&#39;</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">c</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span> <span class="k">if</span> <span class="s">&#39;]&#39;</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">else</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span>
</pre></div>
</td></tr></table><p> 我们再将上面的思路转换为递归代码：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">TRANS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="n">trans_asterisk</span><span class="p">,</span>
    <span class="s">&quot;?&quot;</span><span class="p">:</span> <span class="n">trans_questionmark</span><span class="p">,</span>
    <span class="s">&quot;[&quot;</span><span class="p">:</span> <span class="n">trans_choice</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_translate</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pat</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">trans_func</span> <span class="o">=</span> <span class="n">TRANS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans_default</span><span class="p">)</span>
    <span class="n">res_part</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">trans_func</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_part</span> <span class="o">+</span> <span class="n">_translate</span><span class="p">(</span><span class="n">left_pat</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_translate</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#39;\Z(?ms)&#39;</span>
</pre></div>
</td></tr></table><p> 递归的效率是比较低的，但是我们可以转换成尾递归形式：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">TRANS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="n">trans_asterisk</span><span class="p">,</span>
    <span class="s">&quot;?&quot;</span><span class="p">:</span> <span class="n">trans_questionmark</span><span class="p">,</span>
    <span class="s">&quot;[&quot;</span><span class="p">:</span> <span class="n">trans_choice</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_translate</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pat</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">pat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">handle_func</span> <span class="o">=</span> <span class="n">TRANS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans_default</span><span class="p">)</span>
    <span class="n">res_part</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">handle_func</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_translate</span><span class="p">(</span><span class="n">left_pat</span><span class="p">,</span> <span class="n">res</span> <span class="o">+</span> <span class="n">res_part</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_translate</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="s">&#39;\Z(?ms)&#39;</span>
</pre></div>
</td></tr></table><p> 好了，如果 Python 的解释器支持尾递归，到上面一步就可以了。</p>
<p> 因为支持尾递归就代表解释器会自动将尾递归转换成迭代的形式。</p>
<p> 但是我们必须手工做这一步，不过这也只是手到摛来的事了。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">TRANS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="n">trans_asterisk</span><span class="p">,</span>
    <span class="s">&quot;?&quot;</span><span class="p">:</span> <span class="n">trans_questionmark</span><span class="p">,</span>
    <span class="s">&quot;[&quot;</span><span class="p">:</span> <span class="n">trans_choice</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pat</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_yield_res</span><span class="p">():</span>
        <span class="n">left_pat</span> <span class="o">=</span> <span class="n">pat</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">left_pat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">left_pat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">handle_func</span> <span class="o">=</span> <span class="n">TRANS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">trans_default</span><span class="p">)</span>
            <span class="n">res_part</span><span class="p">,</span> <span class="n">left_pat</span> <span class="o">=</span> <span class="n">handle_func</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">left_pat</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">res_part</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">left_pat</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_yield_res</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39;\Z(?ms)&#39;</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="fnmatch-fnmatchcase">
<h2><a class="toc-backref" href="#id5">fnmatch&amp;&amp;fnmatchcase</a></h2>
<p><cite>fnmatch</cite> 本质上其实就是调用 <cite>fnmatchcase</cite> 来实现的。只不过在调用之前使用了 <cite>os.path.normcase</cite> 方法来消除平台差异而已。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">fnmatchcase</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test whether FILENAME matches PATTERN, including case.</span>

<span class="sd">    This is a version of fnmatch() which doesn&#39;t case-normalize</span>
<span class="sd">    its arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">_MAXCACHE</span><span class="p">:</span>
            <span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">_cache</span><span class="p">[</span><span class="n">pat</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">_cache</span><span class="p">[</span><span class="n">pat</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</pre></div>
</td></tr></table><p> 看了代码就知道它的实现太简单了，将参数中的模式字符串调用 <cite>translate</cite> 函数转换成正则字符串，然后直接使用正则表达式对象的 <cite>match</cite> 方法就完事了。反而是使用了 Cache 这个非主要功能，占用了比较多的代码。</p>
<p> 接下来咱们重新整理一下代码。</p>
<ol class="arabic">
<li><p class="first">Cache 操作直接和函数的主要逻辑混在一起 </p>
<p> 既然使用到 Cache，那么操作 Cache 的具体代码就要封装起来了啊。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LimitedCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LimitedCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__max_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cache_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache_size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__max_size</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="n">CACHE</span> <span class="o">=</span> <span class="n">LimitedCache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fnmatchcase</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_cache_pat</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
        <span class="n">re_pat</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="n">re_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re_pat</span><span class="p">)</span>
        <span class="n">CACHE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ret_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re_obj</span>

    <span class="n">re_obj</span> <span class="o">=</span> <span class="n">CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_cache_pat</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">re_obj</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</pre></div>
</td></tr></table><p> 这样看 <cite>fnmatchcase</cite> 函数是不是比较原来的版本简单明了许多。</p>
</li>
<li><p class="first">Cache 功能好像也不是 <cite>fnmatchcase</cite> 的主要功能吧。</p>
<p> 既然不是主要功能，那么我们就不能和实现主要功能的代码混在一块。</p>
<p> 那怎么实现？</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LimitedCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LimitedCache</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__max_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cache_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache_size</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__max_size</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_full</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="n">CACHE</span> <span class="o">=</span> <span class="n">LimitedCache</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cache_pat</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_cache_pat</span><span class="p">(</span><span class="n">pat</span><span class="p">):</span>
        <span class="n">re_pat</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="n">re_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re_pat</span><span class="p">)</span>
        <span class="n">CACHE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">re_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re_obj</span>

    <span class="k">return</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">pat</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">CACHE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_cache_pat</span><span class="p">(</span><span class="n">pat</span><span class="p">))</span>

<span class="n">fnmatchcase</span> <span class="o">=</span> <span class="n">cache_pat</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">re_obj</span><span class="p">:</span> <span class="n">re_obj</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
<span class="c"># 版本 2</span>
<span class="c"># def fnmatchcase(name, pat):</span>
<span class="c">#     def _fnmatchcase(name, re_obj):</span>
<span class="c">#         return re_obj.match(name) is not None</span>
<span class="c">#     return cache_pat(_fnmatchcase)(name, pat)</span>
<span class="c">#</span>
<span class="c"># 版本 3（问题：修改了 fnmatchcase 的参数）</span>
<span class="c"># @cache_pat</span>
<span class="c"># def fnmatchcase(name, re_obj):</span>
<span class="c">#      return re_obj.match(name) is not None</span>
</pre></div>
</td></tr></table><p> 嗯，这样就差不多了。</p>
</li>
</ol>
</div>
<div class="section" id="filter">
<h2><a class="toc-backref" href="#id6">filter</a></h2>
<p><cite>filter</cite> 也比较简单， 其实就是对一系列的文件名进行 <cite>fnmatchcase</cite> 判断，只保留匹配正确的文件名而已。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the subset of the list NAMES that match PAT&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">posixpath</span>
    <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">pat</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">_cache</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">_MAXCACHE</span><span class="p">:</span>
            <span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">_cache</span><span class="p">[</span><span class="n">pat</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">match</span><span class="o">=</span><span class="n">_cache</span><span class="p">[</span><span class="n">pat</span><span class="p">]</span><span class="o">.</span><span class="n">match</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="n">posixpath</span><span class="p">:</span>
        <span class="c"># normcase on posix is NOP. Optimize it away from the loop.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</td></tr></table><p><cite>filter</cite> 内部的主要逻辑和 <cite>fnmatchcase</cite> 差不多么，为什么不复用？</p>
<blockquote>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">fnfilter</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="c"># 版本 2</span>
    <span class="c"># return filter(fnmatch, names)</span>

<span class="k">def</span> <span class="nf">fnfiltercase</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">fnmatchcase</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="c"># 版本 2</span>
    <span class="c"># return filter(fnmatchcase, names)</span>
</pre></div>
</td></tr></table><p> 怎么样，比原来的代码清晰太多了吧。</p>
</blockquote>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id7"> 总结 </a></h2>
<ol class="arabic">
<li><p class="first"> 你是依据什么原则来吐槽的？</p>
<blockquote>
<p> 一个函数只做一件事。</p>
</blockquote>
</li>
<li><p class="first">Cache 值为什么设为 100？</p>
<blockquote>
<p> 之间我看过相关文章说，Python 源码里的某些具体数值是经过大量实践统计出来，我估计这个数值可能也是统计出来的，当然也可能是写个模块的作者个人喜好吧。</p>
<p>PS：要是我写，我就写 128，哈哈。</p>
</blockquote>
</li>
<li><p class="first"> 能写 Python 标准库的作者水平应该不错，为什么你会挑出这么多毛病？</p>
<blockquote>
<p> 一般写标准库需要考虑：</p>
<ol class="arabic simple">
<li> 库之间的尽量不要有依赖 </li>
<li> 效率要尽量高 </li>
<li> 版本兼容性 </li>
<li>... ...</li>
</ol>
<p>LimitedCache 一方面是为了封装高内聚的操作，一方面也是为了重用。但这两方面在标准库代码中都不是首要的，你封装了一层，那肯定要多调一层代码，效率就降低了，库之间尽量不要有依赖，那重用这一块就更不用提了。</p>
<p><cite>filter</cite> 如果是我那种实现的话，就要每次从 Cache 中取一次 pat。而原来的代码只要在循环开始之前取一次即可。不过话又说回来了，我再提供一个不用 Cache 的 <cite>fnmatchcase</cite> 版本不就行了。</p>
<p>PS：这些都是我自己想的，当然有可能作者觉得这几个功能太简单，没必要将代码设计的太复杂。 <cite>Simple is better than complex.</cite> ， 嘿嘿。</p>
</blockquote>
</li>
</ol>
</div>

            
            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://chenjiee815.github.io/fnmatchbiao-zhun-ku-yuan-ma-xue-xi.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'chenjiee815blog';
        var disqus_identifier = 'http://chenjiee815.github.io/fnmatchbiao-zhun-ku-yuan-ma-xue-xi.html';
    var disqus_url = 'http://chenjiee815.github.io/fnmatchbiao-zhun-ku-yuan-ma-xue-xi.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-09-01T22:56:11.432803">Sep 1, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="http://chenjiee815.github.io/categories.html#python-ref">Python</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://chenjiee815.github.io/tags.html#python-ref">python
                    <span>24</span>
</a></li>
                <li><a href="http://chenjiee815.github.io/tags.html#stdlibs-ref">stdlibs
                    <span>15</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://www.htdp.org/" title="My HTDP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-htdp sidebar-social-links"></i></a>
    <a href="http://mitpress.mit.edu/sicp/" title="My SICP Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-sicp sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>

                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'chenjiee815blog';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>